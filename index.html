<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Qu·∫£n l√Ω t√†i kho·∫£n</title>

<!-- Font ƒë·∫πp -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600&family=Poppins:wght@300;500&display=swap" rel="stylesheet">

<!-- Firebase modular SDK -->
<script type="module">
  // load firebase modules in script below (module used inside main script)
</script>

<style>
/* ===== Base (sky-blue soft) ===== */
:root{
  --blue-1:#e6f7ff;
  --blue-2:#f0faff;
  --accent:#007acc;
  --accent-2:#66c2ff;
  --muted:#666;
}
body{
  font-family: 'Poppins', sans-serif;
  margin:0;
  background: linear-gradient(135deg,var(--blue-1),var(--blue-2));
  min-height:100vh;
  color:#222;
}
.wrap{max-width:980px;margin:28px auto;padding:18px}

/* Card */
.card{
  background:#fff;border-radius:14px;padding:18px;
  box-shadow:0 6px 18px rgba(0,0,0,0.05);
  margin-bottom:18px; animation:appear .45s ease;
}
@keyframes appear{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

/* headings */
h1,h2,h3{margin:0 0 10px 0;color:var(--accent)}

/* layout */
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,select{padding:10px 12px;border-radius:10px;border:2px solid #cdeeff;outline:none;transition:.18s}
input:focus,select:focus{box-shadow:0 0 6px rgba(51,153,255,0.12);border-color:var(--accent-2)}
button{padding:10px 14px;border-radius:18px;border:0;background:linear-gradient(45deg,var(--accent-2),#99ddff);color:#fff;cursor:pointer;font-weight:600;transition:.16s}
button:hover{transform:scale(1.03)}
button.ghost{background:#f6fdff;border:1px solid #d3f0ff;color:var(--accent)}
.muted{color:var(--muted);font-size:13px}

/* table style */
table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:12px}
th,td{padding:12px;background:#fff;border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,0.04);vertical-align:middle}
th{background:var(--blue-1);color:var(--accent)}
img.thumb{width:72px;height:72px;object-fit:cover;border-radius:10px;border:2px solid #dff4ff}

/* logo */
.logo{width:56px;height:56px;object-fit:cover;border-radius:50%;border:3px solid #cfefff;margin-right:10px}

/* overlay (welcome / choose / waiting) */
#loadingOverlay{
  position:fixed;left:0;top:0;width:100%;height:100%;
  display:none;align-items:center;justify-content:center;flex-direction:column;
  background: linear-gradient(135deg, rgba(230,247,255,0.98), rgba(240,250,255,0.98));
  z-index:9999; text-align:center; transition:opacity 1s ease;
}
#loadingOverlay.fade-out{opacity:0;pointer-events:none}
#loadingOverlay h1{font-family:'Baloo 2',cursive;font-size:46px;color:var(--accent);margin:0 0 12px;animation:pop 1s ease infinite alternate}
#loadingOverlay p{font-family:'Baloo 2',cursive;font-size:20px;color:#2d9cff;margin:6px 0}
@keyframes pop{from{transform:scale(1)}to{transform:scale(1.12)}}

/* small controls right */
.top-right{display:flex;gap:8px;margin-left:auto;align-items:center}

/* logout button */
#btnLogout{background:#fff;color:var(--accent);border:1px solid #cfefff;padding:8px 12px;border-radius:12px}

/* responsive */
@media (max-width:700px){
  .row{flex-direction:column}
  input,select{width:100%}
  .logo{width:48px;height:48px}
}
</style>
</head>
<body>

<div class="wrap">

  <!-- LOGIN CARD -->
  <div class="card" id="loginCard">
    <div style="display:flex;align-items:center;gap:10px">
      <img class="logo" id="siteLogo" src="https://raw.githubusercontent.com/HoshinoKotaSouma/shopaccbeorin/main/download%20(3).jpeg" alt="logo">
      <div>
        <div style="font-weight:700;color:var(--accent)">C·ªông T√°c Vi√™n H·ªù G·ªù</div>
        <div class="muted" style="font-size:14px">H·ªá th·ªëng qu·∫£n l√Ω t√†i kho·∫£n</div>
      </div>
    </div>

    <h2 style="margin-top:12px">ƒêƒÉng nh·∫≠p</h2>

    <div class="row" style="margin-top:8px">
      <input id="login_username" placeholder="username">
      <input id="login_password" placeholder="password" type="password">
      <button id="btnLogin">ƒêƒÉng nh·∫≠p</button>
    </div>
    <p id="loginMsg" class="muted" style="margin-top:8px"></p>
    <p class="muted" style="margin-top:6px;font-size:12px">Users l·∫•y t·ª´: GitHub raw (private/public tu·ª≥ repo). </p>
  </div>

  <!-- APP CARD -->
  <div class="card" id="appCard" style="display:none">
    <div style="display:flex;align-items:center">
      <h2 style="margin:0">üìã Qu·∫£n l√Ω t√†i kho·∫£n</h2>
      <div class="top-right" style="margin-left:auto">
        <div class="muted" id="roleLabel">-</div>
        <button id="btnExport" class="ghost">üìÇ Xu·∫•t CSV</button>
        <button id="btnLogout">‚éã ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" style="margin-top:14px;display:none">
      <h3>‚ûï Th√™m t√†i kho·∫£n (Admin)</h3>
      <div class="row" style="margin-top:8px">
        <input id="new_user" placeholder="T√†i kho·∫£n (username)">
        <input id="new_pass" placeholder="M·∫≠t kh·∫©u">
        <input id="new_skin" placeholder="Skin">
        <input id="new_img" placeholder="Link ·∫£nh (https://...)">
        <select id="new_status"><option value="ON">ON</option><option value="OFF">OFF</option></select>
        <button id="btnAdd">Th√™m</button>
      </div>
    </div>

    <!-- filter -->
    <div style="margin-top:12px">
      <div class="row">
        <input id="filter" placeholder="üîç T√¨m MS / username / skin..." style="flex:1">
      </div>
    </div>

    <!-- table -->
    <table id="accTable" style="margin-top:12px">
      <thead><tr></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Overlay welcome / choose / waiting -->
<div id="loadingOverlay" role="dialog" aria-hidden="true">
  <h1 id="welcomeText">Welcomeeee... üíô</h1>
  <p id="roleMsg"></p>

  <div id="chooseAdmin" style="display:none;margin-top:10px">
    <p style="margin:8px 0;font-weight:600">B·∫°n l√† ai ?</p>
    <div style="display:flex;gap:12px;justify-content:center">
      <button id="who1" style="border-radius:12px;padding:10px 18px">Giao B√©o</button>
      <button id="who2" style="border-radius:12px;padding:10px 18px">Qu·ª≥nh Cute</button>
    </div>
  </div>

  <p id="waitingText" style="display:none;margin-top:14px;font-weight:600">Waiting to loading Web<span id="dots">.</span></p>
</div>

<!-- ===== Main script: login from GitHub RAW + Firebase Realtime DB for accounts ===== -->
<script type="module">
/* ---------------- CONFIGS ---------------- */
// RAW GitHub users JSON (you gave this)
const RAW_USERS_URL = "https://raw.githubusercontent.com/HoshinoKotaSouma/ctvhogo/refs/heads/main/accounts.json";

// Firebase config (use your project's keys)
const firebaseConfig = {
  apiKey: "AIzaSyBgkwN-ZLZ6Gv46NZmHQqNYiZYKQ6Zj9b4",
  authDomain: "quanlytaikhoanctvhg.firebaseapp.com",
  databaseURL: "https://quanlytaikhoanctvhg-default-rtdb.firebaseio.com",
  projectId: "quanlytaikhoanctvhg",
  storageBucket: "quanlytaikhoanctvhg.firebasestorage.app",
  messagingSenderId: "702694949499",
  appId: "1:702694949499:web:ad5a0ea230c00150cbd8de",
  measurementId: "G-6W1VK6WFYP"
};

/* ---------------- imports ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, push, set, update, remove, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

/* ---------------- init firebase ---------------- */
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ---------------- state ---------------- */
let usersRemote = null;      // users from GitHub JSON
let currentUser = null;      // {username, role}
const accountsRefPath = "accounts";

/* ---------------- ui helpers ---------------- */
const el = id => document.getElementById(id);
const showMsg = m => el("loginMsg").innerText = m || "";

/* ---------------- fetch users from GitHub RAW ---------------- */
async function loadRemoteUsers(){
  try{
    const res = await fetch(RAW_USERS_URL + "?_="+Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error("Fetch l·ªói: "+res.status);
    const data = await res.json();
    // expecting data.users object
    usersRemote = data.users || null;
    return usersRemote;
  }catch(e){
    console.error(e);
    usersRemote = null;
    showMsg("L·ªói t·∫£i users t·ª´ GitHub: " + e.message);
    return null;
  }
}

/* ---------------- login ---------------- */
async function doLogin(){
  const u = el("login_username").value.trim();
  const p = el("login_password").value;
  if(!u || !p){ showMsg("Nh·∫≠p username + password"); return; }

  if(!usersRemote){
    await loadRemoteUsers();
    if(!usersRemote){ showMsg("Kh√¥ng c√≥ users ƒë·ªÉ ki·ªÉm tra"); return; }
  }

  // find match
  let found = null;
  for(const k in usersRemote){
    const it = usersRemote[k];
    if(it.username === u && it.password === p){
      found = { username: it.username, role: it.role };
      break;
    }
  }
  if(!found){ showMsg("Sai username ho·∫∑c m·∫≠t kh·∫©u!"); return; }

  currentUser = found;
  showMsg("");
  // show overlay welcome + handle admin selection if admin
  startWelcomeFlow();
}

/* ---------------- welcome flow & overlay ---------------- */
function startWelcomeFlow(){
  el("loginCard").style.display = "none";
  const overlay = el("loadingOverlay");
  overlay.style.display = "flex";
  overlay.style.opacity = "1";
  el("roleMsg").innerText = "";
  el("chooseAdmin").style.display = "none";
  el("waitingText").style.display = "none";

  if(currentUser.role === "admin"){
    el("chooseAdmin").style.display = "block";
    // set role msg
    el("roleMsg").innerText = "B·∫°n l√† qu·∫£n tr·ªã vi√™n";
    // attach handlers for choices
    const pick = who=>{
      el("chooseAdmin").style.display = "none";
      el("waitingText").style.display = "block";
      // small personal greeting (optional)
      // start fade out after delay
      setTimeout(()=>fadeOutOverlay(startApp), 2500);
    };
    const who1 = el("who1"), who2 = el("who2");
    who1.onclick = ()=>pick("Giao B√©o");
    who2.onclick = ()=>pick("Qu·ª≥nh Cute");
  } else {
    el("roleMsg").innerText = "B·∫°n l√† c·ªông t√°c vi√™n";
    el("waitingText").style.display = "block";
    setTimeout(()=>fadeOutOverlay(startApp), 2500);
  }

  // animate dots for waiting
  startDots();
}

let dotsInterval = null;
function startDots(){
  const d = el("dots");
  if(dotsInterval) clearInterval(dotsInterval);
  let c = 0;
  dotsInterval = setInterval(()=>{
    c = (c+1)%4;
    d.innerText = ".".repeat(c);
  }, 450);
}

/* fade out overlay smoothly */
function fadeOutOverlay(callback){
  const overlay = el("loadingOverlay");
  overlay.classList.add("fade-out");
  setTimeout(()=>{
    overlay.style.display = "none";
    overlay.classList.remove("fade-out");
    if(dotsInterval){ clearInterval(dotsInterval); dotsInterval = null; el("dots").innerText = "."; }
    callback();
  }, 900); // match CSS transition
}

/* ---------------- start app (show main UI & attach listeners) ---------------- */
function startApp(){
  el("appCard").style.display = "block";
  el("roleLabel").innerText = currentUser.role.toUpperCase();
  if(currentUser.role === "admin") el("adminPanel").style.display = "block"; else el("adminPanel").style.display = "none";

  // attach firebase realtime listener for accounts
  listenAccountsRealtime();

  // wire buttons
  el("btnAdd").onclick = addAccount;
  el("btnExport").onclick = exportCSV;
  el("btnLogout").onclick = logout;
  el("filter").addEventListener("input", renderAccountsFromCache);
}

/* ---------------- firebase: listen accounts in realtime ---------------- */
let accountsCache = {}; // keyed by firebase key
function listenAccountsRealtime(){
  const accRef = ref(db, accountsRefPath);
  onValue(accRef, snapshot=>{
    const val = snapshot.val() || {};
    accountsCache = val;
    // ensure MS exists (we'll generate ms from ordering)
    normalizeMsAndRender();
  });
}

/* create MS based on sorted keys (by push timestamp fallback) */
function normalizeMsAndRender(){
  // convert to array of entries [key, obj]
  const entries = Object.entries(accountsCache);
  // sort by key lexicographically (push keys are time-ordered)
  entries.sort((a,b)=> a[0].localeCompare(b[0]));
  // set ms sequentially
  const newCache = {};
  for(let i=0;i<entries.length;i++){
    const [k,obj] = entries[i];
    newCache[k] = Object.assign({}, obj, { ms: String(i+1).padStart(3,"0") });
  }
  accountsCache = newCache;
  renderAccountsFromCache();
}

/* ---------------- render accounts ---------------- */
function renderAccountsFromCache(){
  const tbody = document.querySelector("#accTable tbody");
  const thead = document.querySelector("#accTable thead tr");
  tbody.innerHTML = "";
  const filter = (el("filter").value || "").toLowerCase();

  // build array from cache
  const arr = Object.entries(accountsCache).map(([key,obj]) => ({ key, ...obj }));
  // header depends on role
  if(currentUser && currentUser.role === "admin"){
    thead.innerHTML = `
      <th style="width:80px">MS</th>
      <th>Username</th>
      <th>Password</th>
      <th>Skin</th>
      <th style="width:120px">·∫¢nh</th>
      <th>T√¨nh Tr·∫°ng Ch·ªß</th>
      <th style="width:180px">H√†nh ƒë·ªông</th>
    `;
  } else {
    thead.innerHTML = `
      <th style="width:80px">MS</th>
      <th>Skin</th>
      <th style="width:120px">·∫¢nh</th>
      <th>T√¨nh Tr·∫°ng Ch·ªß</th>
    `;
  }

  // iterate and render
  arr.forEach((a, idx)=>{
    const text = ((a.ms||"") + " " + (a.username||"") + " " + (a.skin||"")).toLowerCase();
    if(filter && !text.includes(filter)) return;
    const tr = document.createElement("tr");
    if(currentUser && currentUser.role === "admin"){
      tr.innerHTML = `
        <td>${a.ms || String(idx+1).padStart(3,"0")}</td>
        <td>${a.username || ""}</td>
        <td>${a.password || ""}</td>
        <td>${a.skin || ""}</td>
        <td>${a.image ? '<img class="thumb" src="'+a.image+'">' : ''}</td>
        <td>${a.status || "OFF"}</td>
        <td>
          <button data-key="${a.key}" class="btn-edit">‚úèÔ∏è S·ª≠a</button>
          <button data-key="${a.key}" class="btn-del">üóëÔ∏è X√≥a</button>
        </td>
      `;
    } else {
      tr.innerHTML = `
        <td>${a.ms || String(idx+1).padStart(3,"0")}</td>
        <td>${a.skin || ""}</td>
        <td>${a.image ? '<img class="thumb" src="'+a.image+'">' : ''}</td>
        <td>${a.status || "OFF"}</td>
      `;
    }
    tbody.appendChild(tr);
  });

  // attach edit/delete handlers (admin only)
  if(currentUser && currentUser.role === "admin"){
    document.querySelectorAll(".btn-edit").forEach(btn=>{
      btn.onclick = e => {
        const key = btn.dataset.key;
        openEditDialog(key);
      };
    });
    document.querySelectorAll(".btn-del").forEach(btn=>{
      btn.onclick = e => {
        const key = btn.dataset.key;
        deleteAccountConfirm(key);
      };
    });
  }
}

/* ---------------- add account (admin -> write to firebase) ---------------- */
async function addAccount(){
  if(!currentUser || currentUser.role !== "admin"){ alert("Ch·ªâ admin ƒë∆∞·ª£c th√™m"); return; }
  const u = el("new_user").value.trim();
  const p = el("new_pass").value;
  const skin = el("new_skin").value.trim();
  const image = el("new_img").value.trim();
  const status = el("new_status").value;
  if(!u || !p){ alert("Nh·∫≠p username + password"); return; }

  try{
    // push new entry
    const newRef = push(ref(db, accountsRefPath));
    // compute ms based on current entries length
    const entries = Object.keys(accountsCache || {});
    const ms = String(entries.length + 1).padStart(3,"0");
    await set(newRef, { username: u, password: p, skin: skin, image: image, status: status, ms: ms });
    // clear form
    el("new_user").value = ""; el("new_pass").value = ""; el("new_skin").value = ""; el("new_img").value = "";
  }catch(err){
    console.error(err); alert("L·ªói khi th√™m account: "+err.message);
  }
}

/* ---------------- edit account (admin) - open minimal dialog via prompt for quickness ---------------- */
function openEditDialog(key){
  const node = accountsCache[key];
  if(!node){ alert("Kh√¥ng t√¨m th·∫•y account"); return; }
  const u = prompt("S·ª≠a Username", node.username || "");
  if(u === null) return;
  const p = prompt("S·ª≠a Password", node.password || "");
  if(p === null) return;
  const s = prompt("S·ª≠a Skin", node.skin || "");
  if(s === null) return;
  const img = prompt("S·ª≠a Link ·∫£nh", node.image || "");
  if(img === null) return;
  const st = prompt("S·ª≠a T√¨nh Tr·∫°ng (ON/OFF)", node.status || "OFF");
  if(st === null) return;

  // write update
  const upd = { username: u, password: p, skin: s, image: img, status: st, ms: node.ms || node.ms };
  update(ref(db, accountsRefPath + "/" + key), upd).catch(e=>{console.error(e); alert("L·ªói update: "+e.message)});
}

/* ---------------- delete account ---------------- */
function deleteAccountConfirm(key){
  if(!confirm("X√≥a account n√†y ?")) return;
  remove(ref(db, accountsRefPath + "/" + key)).catch(e=>{console.error(e); alert("L·ªói x√≥a: "+e.message)});
}

/* ---------------- export CSV ---------------- */
function exportCSV(){
  // build rows from cache (ordered)
  const arr = Object.entries(accountsCache).sort((a,b)=>a[0].localeCompare(b[0])).map(([,v])=>v);
  const header = ['MS','Username','Password','Skin','Image','Status'];
  const rows = [header].concat(arr.map(a=>[a.ms||"", a.username||"", (currentUser && currentUser.role==='admin')?a.password:"", a.skin||"", a.image||"", a.status||"OFF"]));
  const csv = rows.map(r=>r.map(c => '"' + String(c).replace(/"/g,'""') + '"').join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'accounts.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ---------------- logout ---------------- */
function logout(){
  // clear UI and state
  currentUser = null;
  usersRemote = usersRemote; // keep users loaded
  el("appCard").style.display = "none";
  el("loginCard").style.display = "block";
  showMsg("");
}

/* ---------------- helper: delete all MS renumber if needed (optional) ---------------- */
/* We rely on normalizeMsAndRender to reassign ms based on order when onValue triggers */

/* ---------------- wire login button & pre-load users ---------------- */
el("btnLogin").addEventListener("click", doLogin);

// preload users (non-block)
loadRemoteUsers();
</script>
</body>
</html>
