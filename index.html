<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Qu·∫£n l√Ω t√†i kho·∫£n Li√™n Qu√¢n</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600&family=Poppins:wght@300;500&display=swap" rel="stylesheet">
<style>
:root{--blue1:#e6f7ff;--blue2:#f0faff;--accent:#007acc;--accent2:#66c2ff;--muted:#666}
body{margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(135deg,var(--blue1),var(--blue2));min-height:100vh;color:#222}
.wrap{max-width:1200px;margin:20px auto;padding:16px}
.card{background:#fff;border-radius:14px;padding:18px;margin-bottom:18px;box-shadow:0 6px 18px rgba(0,0,0,0.05)}
h1,h2,h3{margin:0 0 10px;color:var(--accent)}
input,select,textarea{padding:9px 11px;border:2px solid #cdeeff;border-radius:10px;outline:none}
button{padding:9px 14px;border-radius:12px;border:0;background:linear-gradient(45deg,var(--accent2),#99ddff);color:#fff;font-weight:600;cursor:pointer}
button:hover{transform:scale(1.03)}
button.ghost{background:#f6fdff;border:1px solid #d3f0ff;color:var(--accent)}
table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:12px}
th,td{padding:10px;background:#fff;border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,0.04);vertical-align:middle}
th{background:var(--blue1);color:var(--accent)}
img.thumb{width:70px;height:70px;object-fit:cover;border-radius:10px;border:2px solid #dff4ff}
.logo{width:56px;height:56px;border-radius:50%;border:3px solid #cfefff}
#loadingOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;background:linear-gradient(135deg, rgba(230,247,255,0.98), rgba(240,250,255,0.98));z-index:9999;text-align:center;transition:opacity 1s}
#loadingOverlay.fade-out{opacity:0;pointer-events:none}
#popup{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:10000}
#popupContent{background:#fff;padding:20px;border-radius:12px;max-width:900px;max-height:80%;overflow:auto}
.hero-grid label{margin-right:8px}
.skin-grid label{display:inline-block;margin:6px;border-radius:8px;padding:6px 8px;background:#f7fdff;border:1px solid #e6fbff}
.controls{display:flex;gap:8px;align-items:center}
.muted{color:var(--muted)}
@media (max-width:800px){.controls{flex-direction:column;align-items:stretch}table,th,td{font-size:13px}}
</style>
</head>
<body>
<div class="wrap">
  <!-- LOGIN -->
  <div class="card" id="loginCard">
    <div style="display:flex;align-items:center;gap:10px">
      <img class="logo" src="https://raw.githubusercontent.com/HoshinoKotaSouma/shopaccbeorin/main/download%20(3).jpeg" alt="logo">
      <div><div style="font-weight:700;color:var(--accent)">C·ªông T√°c Vi√™n H·ªù G·ªù</div><div class="muted">H·ªá th·ªëng qu·∫£n l√Ω t√†i kho·∫£n</div></div>
    </div>
    <h2 style="margin-top:12px">ƒêƒÉng nh·∫≠p</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <input id="login_username" placeholder="username">
      <input id="login_password" placeholder="password" type="password">
      <button id="btnLogin">ƒêƒÉng nh·∫≠p</button>
    </div>
    <p id="loginMsg" style="color:red;margin-top:8px"></p>
  </div>

  <!-- APP -->
  <div class="card" id="appCard" style="display:none">
    <div style="display:flex;align-items:center">
      <h2>üìã Qu·∫£n l√Ω t√†i kho·∫£n</h2>
      <div class="controls" style="margin-left:auto">
        <div id="roleLabel" class="muted"></div>
        <input id="filter" placeholder="üîç L·ªçc nhanh theo MS / username / skin / gi√°..." style="min-width:240px">
        <button id="btnFind" class="ghost">üîç T√¨m Acc</button>
        <button id="btnExport" class="ghost">üìÇ Xu·∫•t CSV</button>
        <button id="btnLogout" class="ghost">‚éã Logout</button>
      </div>
    </div>

    <!-- ADMIN FORM -->
    <div id="adminPanel" style="display:none;margin-top:12px">
      <h3>‚ûï Th√™m t√†i kho·∫£n</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <input id="new_user" placeholder="Username">
        <input id="new_pass" placeholder="Password">
        <input id="new_price" placeholder="Gi√° Acc">
        <input id="new_img" placeholder="Link ·∫£nh">
        <select id="new_status"><option>ON</option><option>OFF</option></select>
      </div>
      <div style="margin-top:10px">
        <strong>Ch·ªçn t∆∞·ªõng (ch·ªçn 1 ƒë·ªÉ hi·ªán skin):</strong>
        <div id="heroList" class="hero-grid" style="margin-top:8px"></div>
      </div>
      <div style="margin-top:8px">
        <strong>Danh s√°ch skin (ch·ªçn nhi·ªÅu):</strong>
        <div id="skinList" class="skin-grid" style="margin-top:8px"></div>
      </div>
      <div style="margin-top:10px"><button id="btnAdd">Th√™m t√†i kho·∫£n</button></div>
    </div>

    <!-- TABLE -->
    <table id="accTable">
      <thead><tr></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- OVERLAY -->
<div id="loadingOverlay">
  <h1 id="welcomeText">Welcomeeee... üíô</h1>
  <p id="roleMsg"></p>
  <div id="chooseAdmin" style="display:none;margin-top:12px">
    <p style="font-weight:600">B·∫°n l√† ai ?</p>
    <div style="display:flex;gap:10px;justify-content:center">
      <button id="who1">Giao B√©o</button>
      <button id="who2">Qu·ª≥nh Cute</button>
    </div>
  </div>
  <p id="waitingText" style="display:none;font-weight:600;margin-top:12px">Waiting to loading Web<span id="dots">.</span></p>
</div>

<!-- POPUP -->
<div id="popup"><div id="popupContent"></div></div>

<script type="module">
// ====== CONFIG ======
const RAW_USERS_URL = "https://raw.githubusercontent.com/HoshinoKotaSouma/ctvhogo/refs/heads/main/accounts.json";
const firebaseConfig = {
  apiKey: "AIzaSyBgkwN-ZLZ6Gv46NZmHQqNYiZYKQ6Zj9b4",
  authDomain: "quanlytaikhoanctvhg.firebaseapp.com",
  databaseURL: "https://quanlytaikhoanctvhg-default-rtdb.firebaseio.com",
  projectId: "quanlytaikhoanctvhg",
  storageBucket: "quanlytaikhoanctvhg.firebasestorage.app",
  messagingSenderId: "702694949499",
  appId: "1:702694949499:web:ad5a0ea230c00150cbd8de"
};

// ====== HERO DATA (nh√∫ng to√†n b·ªô t·ª´ file b·∫°n g·ª≠i) ======
const HERO_NAMES = ["Airi","Aleister","Alice","Allain","Arduin","Bijan","Billow","Biron","Bolt Baron","Bright","Butterfly","Capheny","Cresht","Elandorr","Elsu","Enzo","Erin","Errol","Fennik","Florentino","Gambit","Gildur","Grakk","Grog","Hayate","Iggy","Ilumia","Ilumia (old)","Jahra","Joker","Kahlii","Keera","Krixi","Krixi (old)","Lorion","Lindis","Lorenzo","Murad","Nikka","Nakroth","Ng·ªô Kh√¥ng","Omen","Ormarr","Paine","Quillen","Raz","Ryoma","Skud","Slimz","Spector","Tel'Annas","Violet","Veera","Valhein","Violet (old)","Wisp","Xeniel","Yorn","Zuka"];
const HERO_SKINS = {
"Airi":["B√≠ch h·∫£i th√°nh n·ªØ","Kiemono","Th·ª© nguy√™n V·ªá th·∫ßn","V≈© Kh√≠ M·ªông Long"],
"Aleister":["HLV b·∫•t b·∫°i"],
"Alice":["Eternal Sailor Chibi Moon","Phi h√†nh gia","Qu√¢n nh·∫°c Athanor"],
"Allain":["H·∫Øc ki·∫øm sƒ© Kirito","Kirito","Tuy·∫øt s∆°n song ki·∫øm"],
"Arduin":["B·∫°ch v·ªá chi·∫øn gi√°p","Ng·∫°o H·ªï H√†n ƒêao"],
"Bijan":["Ho√†ng kim c∆° gi√°p","K√¨nh thi√™n Long K·ªµ","L·ªØ H√†nh Th·ªùi Kh√¥ng"],
"Billow":["Thi√™n T∆∞·ªõng - ƒê·ªô √Åch"],
"Biron":["Yuji Itadori"],
"Bolt Baron":["Thi√™n Ph·ªß - T∆∞ M·ªánh"],
"Bright":["Toshiro Hitsugaya"],
"Butterfly":["Asuna Tia ch·ªõp","Kim ng∆∞ th·∫ßn n·ªØ","Ph∆∞·ª£ng C·ª≠u Thi√™n","Rockgirl Si√™u ƒê·∫≥ng","Stacia","Th√°nh n·ªØ kh·ªüi nguy√™n"],
"Capheny":["Harley Quinn","Kimono"],
"Cresht":["B√°ch T∆∞·ªõng L√£o Tam"],
"Elandorr":["Tuxedo Mask"],
"Elsu":["Th·ª£ SƒÉn B√≥ng ƒê√™m","Ng·ª± L√¢m Th·∫ßn C√¥ng","S√≥i Th·∫ßm L·∫∑ng"],
"Enzo":["Qu·ª∑ H√†nh H∆∞∆°ng","S√°t Th·ªß Hoa Nh·∫≠t"],
"Erin":["Th·ª£ SƒÉn H·∫Øc √Åm","S√°t Th·ªß Th·ªã Tr·∫•n"],
"Errol":["Chi·∫øn Th·∫ßn L·ª≠a"],
"Fennik":["Nh·ªè b√© phi th∆∞·ªùng"],
"Florentino":["B·∫°ch K·ªã Sƒ©","·∫¢nh Ki·∫øm","Xu√¢n Lai Ki·∫øm Kh√°ch"],
"Gambit":["Tay S√∫ng Mi·ªÅn T√¢y"],
"Gildur":["Ho√†ng ƒê·∫ø T·ªôc V√†ng"],
"Grakk":["Qu·ª∑ ƒêao Ng∆∞·ªùi Gi√†"],
"Grog":["Chi·∫øn Binh C·ªï","Vua Chi·∫øn Tr·∫≠n"],
"Hayate":["ƒê·∫°i Ki·∫øm S∆∞","Tinh Linh Ki·∫øm"],
"Iggy":["K·ªπ S∆∞ √Ånh S√°ng"],
"Ilumia":["Thi√™n S·ª© √Ånh TrƒÉng","Th·ªùi Trang Ch·ªß Nghƒ©a"],
"Ilumia (old)":["Phi√™n B·∫£n C≈©"],
"Jahra":["Ph√π Th·ªßy Huy·ªÅn B√≠"],
"Joker":["Ng∆∞·ªùi H·ªÅ Ma Thu·∫≠t"],
"Kahlii":["Qu·ªëc S·∫Øc Th·ªùi ƒê·∫°i"],
"Keera":["B√≥ng ƒê√™m R·ª±c L·ª≠a"],
"Krixi":["N√†ng Ti√™n Hoa","B√≠ch Ng·ªçc T√†n Hoa","Thi√™n Th·∫ßn S√°ng"],
"Krixi (old)":["Phi√™n B·∫£n C≈©"],
"Lorion":["√Ånh TrƒÉng Vƒ©nh H·∫±ng"],
"Lindis":["N·ªØ V∆∞∆°ng R·ª´ng Xanh"],
"Lorenzo":["Hi·ªáp Sƒ© Tr·∫Øng"],
"Murad":["S√°t Th·ªß Th·ªùi Kh√¥ng"],
"Nikka":["N·ªØ Th·∫ßn Na Uy"],
"Nakroth":["Si√™u Vi·ªát","Chi·∫øn Th·∫ßn ƒê·ªãnh M·ªánh","Th·∫ßn Ki·∫øm"],
"Ng·ªô Kh√¥ng":["T·ªÅ Thi√™n ƒê·∫°i Th√°nh"],
"Omen":["K·∫ª B√≥ng ƒê√™m"],
"Ormarr":["Chi·∫øn T∆∞·ªõng H·ªìng","ƒê·∫°i T∆∞·ªõng L·∫´y L·ª´ng"],
"Paine":["Song Ki·∫øm BƒÉng H·ªèa"],
"Quillen":["B√≥ng ƒê√™m S√°t Th·ªß"],
"Raz":["Ninja Th√†nh Ph·ªë","Phi Thi√™n Quy·ªÅn"],
"Ryoma":["Kensei ƒê·ªè"],
"Skud":["Ph√°o Th·ªß Huy·ªÅn Tho·∫°i"],
"Slimz":["Cao B·ªìi Si√™u Qu·∫≠y"],
"Spector":["B√≥ng Ma Ki·∫øm"],
"Tel'Annas":["N·ªØ Th·∫ßn Cung","Chi·∫øn Cung Tia S√°ng"],
"Violet":["X·∫° Th·ªß √Ånh Sao","Thi·∫øu N·ªØ B√£o T√°p"],
"Veera":["N·ªØ Ho√†ng Qu·ª∑","V≈© ƒêi·ªáu ƒê·ªè"],
"Valhein":["Li·ªáp H·∫° S√°t Th·ªß","X·∫° Th·ªß B√£o T√°p"],
"Wisp":["H·ªìn Nhi√™n"],
"Xeniel":["Ch√∫a T·ªÉ Thi√™n ƒê∆∞·ªùng"],
"Yorn":["ƒê·∫•u Sƒ© √Ånh TrƒÉng"],
"Zuka":["Samurai ƒê·ªè"]
};
/* Note: HERO_NAMES and HERO_SKINS were generated from the text files you provided.
   If any skin appears missing/needs renaming, edit HERO_SKINS above.
*/

// ====== Firebase SDK imports ======
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, push, set, update, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

// ====== Init Firebase ======
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ====== State ======
let usersRemote = null;
let currentUser = null;
let accountsCache = {};
let dotsInterval = null;
const el = id => document.getElementById(id);

// ====== Load users from GitHub RAW ======
async function loadUsers(){
  try{
    const res = await fetch(RAW_USERS_URL + "?_=" + Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error("Fetch failed: " + res.status);
    const data = await res.json();
    usersRemote = data.users || null;
    return usersRemote;
  }catch(e){
    console.error(e);
    usersRemote = null;
    el("loginMsg").innerText = "L·ªói t·∫£i users: " + e.message;
    return null;
  }
}

// ====== Login ======
async function doLogin(){
  const u = el("login_username").value.trim();
  const p = el("login_password").value;
  if(!u || !p){ el("loginMsg").innerText = "Nh·∫≠p username + password"; return; }
  if(!usersRemote) await loadUsers();
  if(!usersRemote){ el("loginMsg").innerText = "Kh√¥ng c√≥ users ƒë·ªÉ ki·ªÉm tra"; return; }
  let found = null;
  for(const k in usersRemote){
    const it = usersRemote[k];
    if(it.username === u && it.password === p){ found = { username: it.username, role: it.role }; break; }
  }
  if(!found){ el("loginMsg").innerText = "Sai username ho·∫∑c m·∫≠t kh·∫©u!"; return; }
  currentUser = found;
  el("loginCard").style.display = "none";
  startWelcome();
}

// ====== Welcome overlay flow ======
function startWelcome(){
  const overlay = el("loadingOverlay");
  overlay.style.display = "flex";
  el("roleMsg").innerText = "";
  el("chooseAdmin").style.display = "none";
  el("waitingText").style.display = "none";
  if(currentUser.role === "admin"){ el("roleMsg").innerText = "B·∫°n l√† qu·∫£n tr·ªã vi√™n"; el("chooseAdmin").style.display = "block"; el("who1").onclick = ()=>pickWho('Giao B√©o'); el("who2").onclick = ()=>pickWho('Qu·ª≥nh Cute'); }
  else { el("roleMsg").innerText = "B·∫°n l√† c·ªông t√°c vi√™n"; el("waitingText").style.display = "block"; setTimeout(()=>fadeOutOverlay(startApp), 1800); }
  startDots();
}
function pickWho(name){
  // optional: store selection locally if needed
  el("chooseAdmin").style.display = "none";
  el("waitingText").style.display = "block";
  setTimeout(()=>fadeOutOverlay(startApp), 1200);
}
function startDots(){
  const d = el("dots"); let c = 0;
  if(dotsInterval) clearInterval(dotsInterval);
  dotsInterval = setInterval(()=>{ c = (c+1)%4; d.innerText = ".".repeat(c); }, 400);
}
function fadeOutOverlay(cb){
  const overlay = el("loadingOverlay");
  overlay.classList.add("fade-out");
  setTimeout(()=>{ overlay.style.display = "none"; overlay.classList.remove("fade-out"); if(dotsInterval){ clearInterval(dotsInterval); dotsInterval = null; el("dots").innerText='.' } cb(); }, 900);
}

// ====== Start app ======
function startApp(){
  el("appCard").style.display = "block";
  el("roleLabel").innerText = currentUser.role.toUpperCase();
  if(currentUser.role === "admin") el("adminPanel").style.display = "block"; else el("adminPanel").style.display = "none";
  buildHeroSkinUI();
  listenAccounts();
  el("btnAdd").onclick = addAccount;
  el("btnExport").onclick = exportCSV;
  el("btnLogout").onclick = logout;
  el("filter").addEventListener("input", render);
  el("btnFind").onclick = openFindPanel;
}

// ====== Firebase realtime listener ======
function listenAccounts(){
  const accountsRef = ref(db, "accounts");
  onValue(accountsRef, snapshot => {
    const val = snapshot.val() || {};
    accountsCache = val;
    normalizeMsAndRender();
  });
}

// Normalize MS sequence based on ordering of keys
function normalizeMsAndRender(){
  const entries = Object.entries(accountsCache);
  entries.sort((a,b)=> a[0].localeCompare(b[0]));
  const newCache = {};
  for(let i=0;i<entries.length;i++){
    const [k,obj] = entries[i];
    newCache[k] = Object.assign({}, obj, { ms: String(i+1).padStart(3,'0') });
  }
  accountsCache = newCache;
  render();
}

// ====== Render table ======
function render(){
  const tbody = document.querySelector("#accTable tbody");
  const thead = document.querySelector("#accTable thead tr");
  tbody.innerHTML = "";
  if(currentUser && currentUser.role === "admin"){ thead.innerHTML = `<th style="width:80px">MS</th><th>Username</th><th>Password</th><th>Gi√°</th><th>Skin</th><th style="width:120px">·∫¢nh</th><th>T√¨nh Tr·∫°ng</th><th style="width:180px">H√†nh ƒë·ªông</th>`; }
  else { thead.innerHTML = `<th style="width:80px">MS</th><th>Gi√°</th><th>Skin</th><th style="width:120px">·∫¢nh</th><th>T√¨nh Tr·∫°ng</th>`; }
  const filterText = (el("filter").value || "").toLowerCase();
  const arr = Object.entries(accountsCache).map(([k,v])=>({ key:k, ...v }));
  arr.forEach((a, idx) => {
    const flat = ((a.ms||"") + " " + (a.username||"") + " " + (a.price||"") + " " + (skinSummary(a))).toLowerCase();
    if(filterText && !flat.includes(filterText)) return;
    const tr = document.createElement("tr");
    if(currentUser.role === "admin"){
      tr.innerHTML = `<td>${a.ms}</td>
        <td>${a.username||""}</td>
        <td>${a.password||""}</td>
        <td>${a.price||""}</td>
        <td>${escapeHtml(skinSummary(a))}</td>
        <td>${a.image?'<img class="thumb" src="'+a.image+'">':""}</td>
        <td>${a.status||"OFF"}</td>
        <td>
          <button data-key="${a.key}" class="btn-edit">‚úèÔ∏è S·ª≠a</button>
          <button data-key="${a.key}" class="btn-del">üóëÔ∏è X√≥a</button>
          <button data-key="${a.key}" class="btn-view">üëÅ</button>
        </td>`; 
    } else {
      tr.innerHTML = `<td>${a.ms}</td>
        <td>${a.price||""}</td>
        <td>${escapeHtml(skinSummary(a))}</td>
        <td>${a.image?'<img class="thumb" src="'+a.image+'">':""}</td>
        <td>${a.status||"OFF"}</td>`;
    }
    tbody.appendChild(tr);
  });
  if(currentUser && currentUser.role === "admin"){
    document.querySelectorAll(".btn-edit").forEach(b=>b.onclick = e=>openEditForm(b.dataset.key));
    document.querySelectorAll(".btn-del").forEach(b=>b.onclick = e=>deleteAccountConfirm(b.dataset.key));
    document.querySelectorAll(".btn-view").forEach(b=>b.onclick = e=>openViewSkin(b.dataset.key));
  }
}

// helper: skin summary
function skinSummary(a){
  if(!a.skins) return "";
  return Object.keys(a.skins).map(h => `${h}(${a.skins[h].length})`).join(", ");
}

// escape html
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// ====== Build hero/skin UI ======
function buildHeroSkinUI(){
  const hl = el("heroList"), sl = el("skinList");
  hl.innerHTML = "";
  HERO_NAMES.forEach(h => {
    const label = document.createElement("label");
    label.style.marginRight = "8px";
    label.innerHTML = `<input type="radio" name="hero" value="${h}" data-hero="${h}"> ${h}`;
    hl.appendChild(label);
  });
  hl.addEventListener("change", (ev)=>{
    const hero = ev.target.value;
    renderSkinListForHero(hero);
  });
}
function renderSkinListForHero(hero){
  const sl = el("skinList");
  sl.innerHTML = "";
  const skins = HERO_SKINS[hero] || [];
  skins.forEach(s => {
    const label = document.createElement("label");
    label.className = "skin-item";
    label.innerHTML = `<input type="checkbox" class="skinCheck" data-hero="${hero}" value="${s}"> ${s}`;
    sl.appendChild(label);
  });
}

// ====== Add account (admin) ======
async function addAccount(){
  if(!currentUser || currentUser.role !== "admin"){ alert("Ch·ªâ admin ƒë∆∞·ª£c th√™m acc"); return; }
  const u = el("new_user").value.trim();
  const p = el("new_pass").value;
  const price = el("new_price").value.trim();
  const image = el("new_img").value.trim();
  const status = el("new_status").value;
  if(!u || !p){ alert("Nh·∫≠p username + password"); return; }
  const skins = {};
  document.querySelectorAll(".skinCheck:checked").forEach(cb => {
    const h = cb.dataset.hero;
    if(!skins[h]) skins[h] = [];
    skins[h].push(cb.value);
  });
  try{
    const newRef = push(ref(db, "accounts"));
    await set(newRef, { username: u, password: p, price: price, image: image, status: status, skins: skins });
    el("new_user").value = ""; el("new_pass").value=""; el("new_price").value=""; el("new_img").value="";
    document.querySelectorAll(".skinCheck").forEach(cb=>cb.checked=false);
  }catch(e){ console.error(e); alert("L·ªói th√™m acc: "+e.message); }
}

// ====== Edit account via modal form ======
function openEditForm(key){
  const node = accountsCache[key];
  if(!node) return alert("Kh√¥ng t√¨m th·∫•y acc");
  const html = `<h3>S·ª≠a acc MS ${node.ms||''}</h3>
    <div><label>Username: <input id="edt_user" value="${node.username||''}"></label></div>
    <div><label>Password: <input id="edt_pass" value="${node.password||''}"></label></div>
    <div><label>Gi√°: <input id="edt_price" value="${node.price||''}"></label></div>
    <div><label>·∫¢nh: <input id="edt_img" value="${node.image||''}"></label></div>
    <div><label>TT: <select id="edt_status"><option>ON</option><option>OFF</option></select></label></div>
    <div style="margin-top:8px"><button id="saveEdit">L∆∞u</button> <button id="cancelEdit">H·ªßy</button></div>`;
  el("popupContent").innerHTML = html;
  el("popup").style.display = "flex";
  document.getElementById("edt_status").value = node.status || "OFF";
  document.getElementById("cancelEdit").onclick = ()=>el("popup").style.display="none";
  document.getElementById("saveEdit").onclick = async ()=>{
    const u = document.getElementById("edt_user").value;
    const p = document.getElementById("edt_pass").value;
    const pr = document.getElementById("edt_price").value;
    const img = document.getElementById("edt_img").value;
    const st = document.getElementById("edt_status").value;
    try{ await update(ref(db, "accounts/"+key), { username: u, password: p, price: pr, image: img, status: st }); el("popup").style.display="none"; }catch(e){alert("L·ªói update: "+e.message)}
  };
}

// ====== Delete confirm ======
function deleteAccountConfirm(key){
  if(!confirm("X√≥a acc n√†y?")) return;
  remove(ref(db, "accounts/"+key)).catch(e=>alert("L·ªói x√≥a: "+e.message));
}

// ====== View skin detail (admin) ======
function openViewSkin(key){
  const node = accountsCache[key];
  if(!node) return alert("Kh√¥ng t√¨m th·∫•y");
  let html = `<h3>Chi ti·∫øt skin MS ${node.ms||''}</h3>`;
  if(node.skins){
    for(const h of Object.keys(node.skins)){ html += `<b>${h}</b><ul>` + node.skins[h].map(s=>`<li>${escapeHtml(s)}</li>`).join('') + `</ul>`; }
  } else html += "<p>Kh√¥ng c√≥ skin</p>";
  html += `<div style="margin-top:8px"><button onclick="closePopup()">ƒê√≥ng</button></div>`;
  el("popupContent").innerHTML = html;
  el("popup").style.display = "flex";
}

// ====== Close popup ======
function closePopup(){ el("popup").style.display = "none"; }

// ====== Export CSV ======
function exportCSV(){
  const arr = Object.entries(accountsCache).map(([k,v])=>v);
  const header = ['MS','Username','Password','Price','Skins','Image','Status'];
  const rows = [header].concat(arr.map(a=>[a.ms||'', a.username||'', (currentUser && currentUser.role==='admin')?a.password:'', a.price||'', skinSummary(a), a.image||'', a.status||'']));
  const csv = rows.map(r => r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'accounts.csv'; a.click(); URL.revokeObjectURL(url);
}

// ====== Find panel for CTV (modal style) ======
function openFindPanel(){
  if(!currentUser || currentUser.role !== 'ctv') return alert("Ch·ª©c nƒÉng t√¨m ch·ªâ d√†nh cho CTV");
  let html = `<h3>T√¨m Acc</h3>
    <div style="margin-top:8px"><button id="tabMS">T√¨m theo MS</button> <button id="tabSkin">T√¨m theo Skin</button></div>
    <div id="findBody" style="margin-top:10px"></div>
    <div style="margin-top:10px"><button id="closeFind">ƒê√≥ng</button></div>`;
  el("popupContent").innerHTML = html; el("popup").style.display = "flex";
  document.getElementById("closeFind").onclick = ()=>closePopup();
  document.getElementById("tabMS").onclick = ()=>renderFindMS();
  document.getElementById("tabSkin").onclick = ()=>renderFindSkin();
  renderFindMS();
}
function renderFindMS(){
  const body = el("findBody");
  body.innerHTML = `<div>Nh·∫≠p MS (vd: 001): <input id="findMS"> <button id="doFindMS">T√¨m</button></div><div id="findResult" style="margin-top:8px"></div>`;
  document.getElementById("doFindMS").onclick = ()=>{ const ms = document.getElementById("findMS").value.trim(); const res = []; for(const k in accountsCache){ if((accountsCache[k].ms||'')===ms) res.push(accountsCache[k]); } showFindResults(res); };
}
function renderFindSkin(){
  const body = el("findBody");
  body.innerHTML = `<div>Ch·ªçn t∆∞·ªõng: <select id="findHero">` + HERO_NAMES.map(h=>`<option>${h}</option>`).join('') + `</select></div>
    <div style="margin-top:8px">Ch·ªçn skin: <select id="findSkin"></select></div>
    <div style="margin-top:8px"><button id="doFindSkin">T√¨m</button></div>
    <div id="findResult" style="margin-top:8px"></div>`;
  const fh = document.getElementById("findHero"), fs = document.getElementById("findSkin");
  function refreshSkins(){ const h = fh.value; const skins = HERO_SKINS[h]||[]; fs.innerHTML = skins.map(s=>`<option>${s}</option>`).join(''); }
  fh.onchange = refreshSkins; refreshSkins();
  document.getElementById("doFindSkin").onclick = ()=>{ const h = fh.value; const s = fs.value; const res = []; for(const k in accountsCache){ const node = accountsCache[k]; if(node.skins && node.skins[h] && node.skins[h].includes(s)) res.push(node); } showFindResults(res); }
}
function showFindResults(arr){
  const container = document.getElementById("findResult");
  if(!arr || arr.length===0){ container.innerHTML = "<div>Kh√¥ng t√¨m th·∫•y</div>"; return; }
  container.innerHTML = arr.map(a=>`<div style="padding:8px;border-radius:8px;border:1px solid #eef; margin-bottom:8px"><div><b>MS:</b> ${a.ms||''} <b style="margin-left:12px">Gi√°:</b> ${a.price||''}</div><div style="margin-top:6px">${a.image?'<img src="'+a.image+'" class="thumb">':''} <span style="margin-left:8px"><b>TT:</b> ${a.status||''}</span></div></div>`).join('');
}

// ====== Logout ======
function logout(){ location.reload(); }

// ====== Helpers ======
function buildHeroUIForAdd(){ buildHeroSkinUI(); }
el("btnLogin").addEventListener("click", doLogin);
el("btnLogout").addEventListener("click", logout);

// pre-load users
loadUsers();

// expose closePopup to global
window.closePopup = closePopup;
</script>
</body>
</html>
