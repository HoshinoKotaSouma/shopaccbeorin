// ====== CONFIG ======
const RAW_USERS_URL = "https://raw.githubusercontent.com/HoshinoKotaSouma/ctvhogo/refs/heads/main/accounts.json";

// ====== Load users từ GitHub RAW ======
async function loadUsers(){
  try{
    const res = await fetch(RAW_USERS_URL + "?_=" + Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error("Fetch failed: " + res.status);
    const data = await res.json();
    usersRemote = data.users || null;
    return usersRemote;
  }catch(e){
    console.error(e);
    usersRemote = null;
    el("loginMsg").innerText = "Lỗi tải users: " + e.message;
    return null;
  }
}

// ====== Login function gốc ======
async function doLogin(){
  const u = el("login_username").value.trim();
  const p = el("login_password").value;
  if(!u || !p){ 
    el("loginMsg").innerHTML = '<i class="fas fa-exclamation-triangle"></i> Nhập username + password'; 
    return; 
  }
  if(!usersRemote) await loadUsers();
  if(!usersRemote){ 
    el("loginMsg").innerHTML = '<i class="fas fa-exclamation-triangle"></i> Không có users để kiểm tra'; 
    return; 
  }
  let found = null;
  for(const k in usersRemote){
    const it = usersRemote[k];
    if(it.username === u && it.password === p){ found = { username: it.username, role: it.role }; break; }
  }
  if(!found){ 
    el("loginMsg").innerHTML = '<i class="fas fa-times-circle"></i> Sai username hoặc mật khẩu!'; 
    return; 
  }
  currentUser = found;
  el("loginCard").style.display = "none";
  startWelcome();
}